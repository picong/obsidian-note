
# 账户业务模块

## 1、账户介绍

### 1.1、环境

#### 1.1.1、开发环境：

1.1 portal : [http://192.168.3.151:8090/#!index_page](http://192.168.3.151:8090/#!index_page) superadmin / 123456

1.2 VM地址：192.168.3.151 22 user wftapp passwd 密码见[showDoc文档](http://192.168.1.19/web/#/56?page_id=624)

#### 1.1.2、验证环境

1.1 portal : [http://192.168.3.151:8190/#!index_page](http://192.168.3.151:8190/#!index_page) superadmin / 123456

1.2 VM地址：192.168.3.151 22 user wftapp passwd 密码见[showDoc文档](http://192.168.1.19/web/#/56?page_id=624)

#### 1.1.3、其他

192.168.3.151 上有个squid代理，ANB的访问是通过这个机器的出网IP访问的，squid监听端口3228

postman设置

![image-20230306141224477](file://E:/wallyt/%E8%B4%A6%E6%88%B7%E7%B3%BB%E7%BB%9F%E6%A2%B3%E7%90%86/%E8%B4%A6%E6%88%B7%E4%BA%A4%E6%8E%A5/image/image-20230306141224477.png?lastModify=1690789408)

sp-dp 应用部署环境：192.168.3.151，portal应用地址 [http://192.168.3.151:8089/#!dp_aisle](http://192.168.3.151:8089/#!dp_aisle) superadmin / 123456

### 1.2、git地址

#### 1.2.1 git地址

[https://gitlab.wallyt.com/tiqmo_account](https://gitlab.wallyt.com/tiqmo_account)

##### **1.2.1.1基础包**：

sp-dependencies,sp-utils,sp-cache,sp-datasource,sp-dubbo,sp-task,rdp-sys,sp-framework 这些模块是应用的基础依赖包

##### **1.2.1.2应用包**：

sp-gateway,aia-tcs-proxy,aia-cms,aia-acs,aia-css,aia-msg,aia-sas,aia-tcs,aia-oms,aia-as

```ad-note
说明： sp-gateway是账户网关，现在虽然都是通过dubbo调用，但通道回调还是会使用这个网关，回调配置 zt_aia_base.cms_notify ，此表主要是做_线上记录，没有实际业务处理_

```
##### **1.2.1.3 mock应用使用介绍**：

sp-dp 此应用模拟三方应用返回需要的数据

1、配置支持xml响应和json的响应。

2、sp-dp处理流程：MockForwardFilter 拦截/public/mock/*的请求，将后面的一串截取到wallyt_sp_dp.dp_mock表中找对应的匹配的URI，根据wallyt_sp_dp.dp_mock_item中配置的匹配条件，返回对应的响应数据。

3、 配置数据中的特殊符号使用：@copyAll 按照请求参数原数据返回；

@copy copy请求参数中的字段值； 返回请求参数中pan字段的前6后四数据 ![image-20230306112908655](file://E:/wallyt/%E8%B4%A6%E6%88%B7%E7%B3%BB%E7%BB%9F%E6%A2%B3%E7%90%86/%E8%B4%A6%E6%88%B7%E4%BA%A4%E6%8E%A5/image/image-20230306112908655.png?lastModify=1690789408)

@now 返回字段按照对应的格式返回字符串的日期格式：![image-20230306113424717](file://E:/wallyt/%E8%B4%A6%E6%88%B7%E7%B3%BB%E7%BB%9F%E6%A2%B3%E7%90%86/%E8%B4%A6%E6%88%B7%E4%BA%A4%E6%8E%A5/image/image-20230306113424717.png?lastModify=1690789408)

@id 返回的字段按照id后面的配置生成对应位数的随机数字串 （字符串）![image-20230306113657399](file://E:/wallyt/%E8%B4%A6%E6%88%B7%E7%B3%BB%E7%BB%9F%E6%A2%B3%E7%90%86/%E8%B4%A6%E6%88%B7%E4%BA%A4%E6%8E%A5/image/image-20230306113657399.png?lastModify=1690789408)

应用配置的调用sp-dp的url ： ​ 以账户为例：以下是按照三方真实的接口地址上的参数，配置对应的mock地址url（mock地址也配置对应的参数数据）

![image-20230306114831908](file://E:/wallyt/%E8%B4%A6%E6%88%B7%E7%B3%BB%E7%BB%9F%E6%A2%B3%E7%90%86/%E8%B4%A6%E6%88%B7%E4%BA%A4%E6%8E%A5/image/image-20230306114831908.png?lastModify=1690789408)

            通道接入层传入对应的参数：

![image-20230306133413876](file://E:/wallyt/%E8%B4%A6%E6%88%B7%E7%B3%BB%E7%BB%9F%E6%A2%B3%E7%90%86/%E8%B4%A6%E6%88%B7%E4%BA%A4%E6%8E%A5/image/image-20230306133413876.png?lastModify=1690789408)

参数数据填充：

![image-20230306133630355](file://E:/wallyt/%E8%B4%A6%E6%88%B7%E7%B3%BB%E7%BB%9F%E6%A2%B3%E7%90%86/%E8%B4%A6%E6%88%B7%E4%BA%A4%E6%8E%A5/image/image-20230306133630355.png?lastModify=1690789408)

```ad-note
**注意事项**：

1、关于Mock应用中如果修改了dp_mock_item中某个配置的规则，需要删除缓存，才能生效

mock应用接受请求URI的缓存 key DP_MOCK:uri(请求的uri)

mock_item 返回数据的缓存key， DP_MOCK_ITEM:id(数据库中的dp_mock_item.id)
```

### 1.3、代码打包

1、涉及基础包的修改在本地部署到开发和验证的私服器上，然后打依赖包（jenkin没有做配置来构建依赖包，而是使用拉取私服依赖包的方式构建应用包）

2、应用包依赖的facade包在本地部署到开发和验证的私服器上（同上）

3、各个应用模块的构建打包选择的profile见下面。 【项目模块介绍】

### 1.4、构建

#### 1.4.1、账户侧的部署：

|应用|打包方式|备注|
|---|---|---|
|aia-acs-service|single|需要独立部署|
|aia-oms|mulit-gw|需要独立部署|
|aia-tcs-service|mulit|需要独立部署|
|aia-tcs-proxy|mulit|集成到tcs部署（无需独立部署）|
|aia-as|single|需要独立部署|
|sp-gateway-core|standAlone|需要独立部署|
|aia-css|mulit|集成到as部署（无需独立部署）|
|aia-cms|mulit|集成到oms部署（无需独立部署）|
|aia-msg|mulit|集成到oms部署（无需独立部署）|
|aia-sas|mulit|集成到oms部署（无需独立部署）|

#### 1.4..2 注意点：

涉及基础包的修改先部署发布基础包到私服

idea 本地发布出现的问题：

![image-20230306141640452](file://E:/wallyt/%E8%B4%A6%E6%88%B7%E7%B3%BB%E7%BB%9F%E6%A2%B3%E7%90%86/%E8%B4%A6%E6%88%B7%E4%BA%A4%E6%8E%A5/image/image-20230306141640452.png?lastModify=1690789408)

处理方式：

![image-20230306142232806](file://E:/wallyt/%E8%B4%A6%E6%88%B7%E7%B3%BB%E7%BB%9F%E6%A2%B3%E7%90%86/%E8%B4%A6%E6%88%B7%E4%BA%A4%E6%8E%A5/image/image-20230306142232806.png?lastModify=1690789408)

#### 1.4..3 Maven

1、开发Maven仓库

![image-20230306142553429](file://E:/wallyt/%E8%B4%A6%E6%88%B7%E7%B3%BB%E7%BB%9F%E6%A2%B3%E7%90%86/%E8%B4%A6%E6%88%B7%E4%BA%A4%E6%8E%A5/image/image-20230306142553429.png?lastModify=1690789408)

2、验证maven仓库

![image-20230306142456774](file://E:/wallyt/%E8%B4%A6%E6%88%B7%E7%B3%BB%E7%BB%9F%E6%A2%B3%E7%90%86/%E8%B4%A6%E6%88%B7%E4%BA%A4%E6%8E%A5/image/image-20230306142456774.png?lastModify=1690789408)

### 1.5、版本 注意事项

oms-web依赖的sp-framework版本是3.0.4 (对应master分支)，其他应用模块依赖的sp-framework版本3.0.3（对应3.0.3分支）

### 1.6、项目模块介绍

#### 1.6.1简单介绍：

主要介绍下目前主要使用的应用模块

oms 应用

oms 应用主要提供了portal的相关功能，内部聚合了cms（客户信息，短信），sas(数据统计)， msg(消息渠道，邮件)，css-web(对账清结算表现层)

acs 应用

账户核心，交易依托的载体。主要记录了用户账户的虚拟余额，对用户余额进行冻结、解冻，扣款、加款操作并及记录虚拟资金交易流水

tcs 应用

交易核心，订单交易的核心。此模块聚合了通道层进行通道交易（tcs-proxy,此处主要对接通道将通道的个性化处理，抽象出通用的交易数据返回到tcs层进行处理）。根据通道交易结果对账户进行操作，可能冻结、解冻、可能加款，也可能扣款。

as 应用

对账清算应用，该层主要聚合了css模块的task任务模块，包含了通道账单拉取、解析、对账，使用多数据源获取本地数据及账单进行本地对账；对账结束后需要对对账数据按照业务要求进行统计生成清分记录。（当前没有账务系统，没对交易进行核算）

#### 1.6.2 详细功能介绍

见 [https://www.tapd.cn/39147017/markdown_wikis/show/#1139147017001000660](https://www.tapd.cn/39147017/markdown_wikis/show/#1139147017001000660)

### 1.7、账户结构

#### 1.7.1 账户的层级结构:

目前我们系统使用的主要是二级账户体系，及主账户下挂多个功能账户的场景，代码中暂为支持多级层级结构。

![image-20230307152538078](file://E:/wallyt/%E8%B4%A6%E6%88%B7%E7%B3%BB%E7%BB%9F%E6%A2%B3%E7%90%86/%E8%B4%A6%E6%88%B7%E4%BA%A4%E6%8E%A5/image/image-20230307152538078.png?lastModify=1690789408)

#### 1.7.2、开户介绍：

前提：配置好合作伙伴支持的币种，配置好开户类型，如果开户的账户类型不支持需要自行开发对应的功能账户。（cn.swiftpass.aia.acs.factory.AccountFactory#getAccount）

1、配置开户策略（如果可透支，只能脚本修改数据标识）[[以配置内部户的运营户开户策略为例]]

![img](file://E:/wallyt/%E8%B4%A6%E6%88%B7%E7%B3%BB%E7%BB%9F%E6%A2%B3%E7%90%86/%E8%B4%A6%E6%88%B7%E4%BA%A4%E6%8E%A5/image/wps1.jpg?lastModify=1690789408)

2、postman开户：（从登陆的portal请求中获取cookie，填入postman的header中）

![image-20230306153946551](file://E:/wallyt/%E8%B4%A6%E6%88%B7%E7%B3%BB%E7%BB%9F%E6%A2%B3%E7%90%86/%E8%B4%A6%E6%88%B7%E4%BA%A4%E6%8E%A5/image/image-20230306153946551.png?lastModify=1690789408)

2.1、postman开客户新账户 (operateType 0: 开新主子户 1：新增子账户)

![image-20230306154133290](file://E:/wallyt/%E8%B4%A6%E6%88%B7%E7%B3%BB%E7%BB%9F%E6%A2%B3%E7%90%86/%E8%B4%A6%E6%88%B7%E4%BA%A4%E6%8E%A5/image/image-20230306154133290.png?lastModify=1690789408)

2.2、postman给主账户新增一个子账户[下图为添加过渡户示例，cookie同上]

![image-20230306160401344](file://E:/wallyt/%E8%B4%A6%E6%88%B7%E7%B3%BB%E7%BB%9F%E6%A2%B3%E7%90%86/%E8%B4%A6%E6%88%B7%E4%BA%A4%E6%8E%A5/image/image-20230306160401344.png?lastModify=1690789408)

注意目前系统已经在使用特殊用途的账户：

1、openloop： 企业（"customerType":"2"）普通户 {"accountType":"100","accountCurr":"SAR"},{"accountType":"101","accountCurr":"SAR"} 开通的是基本户（100）和待结算户（101），实际使用的是账户类型是100 的基本户

2、NI收入： 机构（"customerType":"3"）收入户（"accountType":"301"）

3、sada退款： 内部（"customerType":"4"） 运营户（"accountType":"306"）

运营户 ： 新建营销发行方的时候会开通 企业（"customerType":"2"）运营户（"accountType":"306"）、营销户（"accountType":"305"）、过渡户（"accountType":"301"）

营销户 ： 上面运营户开通时会开通营销户，营销系统的这个营销户只要是划活动预算的，当开启活动是虚拟资金就从运营户划到营销户，此活动的具体活动核销是活动自身控制，，活动结束或到期就

基本户 ： APP用户开户时开的基本账户

待结算户：商户的待结算户，目前商户的待结算户没有具体场景中使用到，对商户的结算需要依靠收单的对账清分结果，由收单提供结算对账单，账户提供打款通道，进行商户结算，所以我们系统是需要和收单进行捆绑销售的。如果提供api对接合作伙伴收单，可提供账户交易功能，提供的账单文件即钱包对平后的账单文件。

```ad-note
### 注意点：

1、开户必须是合作伙伴支持的币种范围

2、为了避免交易风险，在portal上是不展示将账户设置为可透支的，只能通过审批流程走脚本修改账户属性。

```
## 1.8、交易

### 1.8.1 充值：

#### 1.8.1.1 绑卡充值

（目前支持的绑卡方式可支持OTP绑卡-api预签约，3DES绑卡-网页预签约，绑三方账户），绑卡充值是使用已绑定的卡为账户充值。账户已经支持的通道有checkout（google pay ，apple pay，card pay）、hyperpay（apple pay ， card pay）、国内快钱（快捷支付业务）

钱包请求账户会指定协议编号为对应的账号充值某币种类型的金额额度。账户根据协议编号校验卡信息及账户状态等，组装通道参数请求通道，根据通道返回交易状态，判定是否为用户加钱。具体流程见 aia-doc\03-系统设计\交易流程图

#### 1.8.1.2 直接充值

场景： 用户或合作伙伴在钱包体系外部完成收款后，调用钱包充值接口完成账户加款，目前Tiqmo没有具体场景使用到。

#### 1.8.1.3 账单充值

目前的主要场景是IBAN充值、营销loyalty账户充值、sadad 退款交易处理

**IBAN充值**：钱包侧拉取ominibus账户的交易记录，由钱包发起账单充值，如果账户余额超过月限额需要将超过的部分转到用户的过渡户，等待后面某一天再转入用户余额户。

需求见：[https://www.tapd.cn/58447337/prong/stories/view/1158447337001008691](https://www.tapd.cn/58447337/prong/stories/view/1158447337001008691)

设计见：[https://www.tapd.cn/39147017/markdown_wikis/show/#1139147017001001189](https://www.tapd.cn/39147017/markdown_wikis/show/#1139147017001001189)

**营销loyalty账户充值**：此交易由营销发起，拉到账单流水后为营销的运营户充值。此交易没有限制余额限额

**sadad 退款交易处理**：钱包的sadad退款定时任务拉取Debit账户sadad退款账单流水，为内部营销账户加款，没有账户月余额限制。

## 1.8.2 支付：

### 1.8.2.1、商户相关交易

商户相关的交易包括钱包mch的购券、充值等场景交易，以及spay、H5、App2APP发起的支付交易。

支付具体流程 见：aia-doc\03-系统设计\交易流程图

### 1.8.2.2、立减交易

当前钱包的立减交易，在钱包发起的是支付接口，从营销账户做支付交易，用户支付的金额是订单金额+Fee + vat 后扣除立减金额后的金额

流程图见支付流程图

设计见： [https://www.tapd.cn/39147017/markdown_wikis/show/#1139147017001000427](https://www.tapd.cn/39147017/markdown_wikis/show/#1139147017001000427)

## 1.8.3 转账：

系统用户账户内部转账、openloop内部账户转账、NI卡费转账，SadaRefund转账、营销返现、营销活动启用，营销活动结束结算、结算退款

详细见接口文档：aia-doc\05-接口文档\一账通业务接口规范1.5.8.docx

## 1.8.4 提现：

钱包使用的场景： IBAN提现，Sadad交易

IBAN提现APP发起提现，请求ANB提现，先冻结账户余额，根据通道返回结果修改提现状态，进行解冻（失败）或扣款操作。

Sadad交易设计见：[https://www.tapd.cn/39147017/markdown_wikis/show/#1139147017001001222](https://www.tapd.cn/39147017/markdown_wikis/show/#1139147017001001222)

## 1.8.5 退款：

场景： 支付退款、立减退款

用户支付的订单进行支付退款处理。

立减退款设计见：

[https://www.tapd.cn/39147017/markdown_wikis/show/#1139147017001000440](https://www.tapd.cn/39147017/markdown_wikis/show/#1139147017001000440)

**【Note】营销：营销交易在账户侧是无感知的，账户不知道具体的交易类型是源于什么场景的**

## 1.9、通道对接

### 1.9.1 hyperpay

需求：[https://www.tapd.cn/58447337/prong/stories/view/1158447337001008703?url_cache_key=from_url_iteration_list_b09d5b9bf8b513387c71f4c3d19d251c&action_entry_type=stories](https://www.tapd.cn/58447337/prong/stories/view/1158447337001008703?url_cache_key=from_url_iteration_list_b09d5b9bf8b513387c71f4c3d19d251c&action_entry_type=stories)

设计：[https://www.tapd.cn/39147017/markdown_wikis/show/#1139147017001001191](https://www.tapd.cn/39147017/markdown_wikis/show/#1139147017001001191)

### 1.9.2 ANB：

需求：[https://www.tapd.cn/58447337/prong/stories/view/1158447337001007025?url_cache_key=738c0d6936ce8f6cc7c5be4047d99647&action_entry_type=story_tree_list](https://www.tapd.cn/58447337/prong/stories/view/1158447337001007025?url_cache_key=738c0d6936ce8f6cc7c5be4047d99647&action_entry_type=story_tree_list)

设计：[https://www.tapd.cn/39147017/markdown_wikis/show/#1139147017001000992](https://www.tapd.cn/39147017/markdown_wikis/show/#1139147017001000992)

接口地址：[https://developer.anb.com.sa/apis/api/](https://developer.anb.com.sa/apis/api/)

[ANB随记文档]  ./anb对账随记.pdf  随记文档

postman文件：见aia-doc\04-第三方接口文档\New ANB\B2B.postman_collection.json

代码中的秘钥信息配置在通道配置记录中

通道费率配置（如果涉及的话，目前主要是ANB和Hyperpay会配置通道费率, 具体见概设）

## 1.10 定时任务

### 1.10.1、对账相关的任务

主要是css-task 中的相关的任务

调度机制及数据模型见： [https://www.tapd.cn/39147017/markdown_wikis/show/#1139147017001001076](https://www.tapd.cn/39147017/markdown_wikis/show/#1139147017001001076)

#### 1.10.1.1、周期任务

在任务参数中配置周期任务，任务表中也需要配置任务。注：不同的环境根据参数的不同需要修改对应的数据

##### 1.10.1.1.1、portal上新增操作

![image-20230308114552018](file://E:/wallyt/%E8%B4%A6%E6%88%B7%E7%B3%BB%E7%BB%9F%E6%A2%B3%E7%90%86/%E8%B4%A6%E6%88%B7%E4%BA%A4%E6%8E%A5/image/image-20230308114552018.png?lastModify=1690789408)

#### ![image-20230308114728091](file://E:/wallyt/%E8%B4%A6%E6%88%B7%E7%B3%BB%E7%BB%9F%E6%A2%B3%E7%90%86/%E8%B4%A6%E6%88%B7%E4%BA%A4%E6%8E%A5/image/image-20230308114728091.png?lastModify=1690789408)

添加周期任务：

![image-20230308115107425](file://E:/wallyt/%E8%B4%A6%E6%88%B7%E7%B3%BB%E7%BB%9F%E6%A2%B3%E7%90%86/%E8%B4%A6%E6%88%B7%E4%BA%A4%E6%8E%A5/image/image-20230308115107425.png?lastModify=1690789408)

##### 1.10.1.1.2、使用脚本

部署说明指明需要注意(**开发自测并且css-task.yml有对应的接入器、解析器、处理器**)

**注意：**

新的接入器、解析器、处理器，页面需要添加对应的词条并且css-task.yml需要添加对应的任务条目

#### 1.10.1.2、非周期任务

在任务参数中配置非周期任务即可。

##### 1.10.1.2.1、portal上新增操作

( 1、机器名，此字段主要是为了对账单节点跑任务，配置了要和aia-css.yml中css.terminal.name一致才能加载任务)

![](file://E:/wallyt/%E8%B4%A6%E6%88%B7%E7%B3%BB%E7%BB%9F%E6%A2%B3%E7%90%86/%E8%B4%A6%E6%88%B7%E4%BA%A4%E6%8E%A5/image/image-20230308105447014.png?lastModify=1690789408)

![image-20230308105704544](file://E:/wallyt/%E8%B4%A6%E6%88%B7%E7%B3%BB%E7%BB%9F%E6%A2%B3%E7%90%86/%E8%B4%A6%E6%88%B7%E4%BA%A4%E6%8E%A5/image/image-20230308105704544.png?lastModify=1690789408)

接入器、解析器、处理器一定要在css-task.yml存在

![image-20230308112620370](file://E:/wallyt/%E8%B4%A6%E6%88%B7%E7%B3%BB%E7%BB%9F%E6%A2%B3%E7%90%86/%E8%B4%A6%E6%88%B7%E4%BA%A4%E6%8E%A5/image/image-20230308112620370.png?lastModify=1690789408)

###### 1.10.1.2.1.1 注意

新的接入器、解析器、处理器，页面需要添加对应的词条并且css-task.yml需要添加对应的任务条目

![image-20230308152355614](file://E:/wallyt/%E8%B4%A6%E6%88%B7%E7%B3%BB%E7%BB%9F%E6%A2%B3%E7%90%86/%E8%B4%A6%E6%88%B7%E4%BA%A4%E6%8E%A5/image/image-20230308152355614.png?lastModify=1690789408)

##### 1.10.1.2.2、使用脚本

部署说明指明需要注意(**开发自测并且css-task.yml有对应的接入器、解析器、处理器**)

![任务中提测部署脚本说明](file://E:/wallyt/%E8%B4%A6%E6%88%B7%E7%B3%BB%E7%BB%9F%E6%A2%B3%E7%90%86/%E8%B4%A6%E6%88%B7%E4%BA%A4%E6%8E%A5/image/image-20230308103253854.png?lastModify=1690789408)

#### 1.10.1.3、任务执行

见：[https://www.processon.com/mindmap/64083a4fd7a4e608f6eb217c](https://www.processon.com/mindmap/64083a4fd7a4e608f6eb217c)

##### 1.10.1.3.1 任务入口

cn.swiftpass.aia.css.task.CssTaskStarter

![image-20230308133908251](file://E:/wallyt/%E8%B4%A6%E6%88%B7%E7%B3%BB%E7%BB%9F%E6%A2%B3%E7%90%86/%E8%B4%A6%E6%88%B7%E4%BA%A4%E6%8E%A5/image/image-20230308133908251.png?lastModify=1690789408)

##### 1.10.1.3.2 任务加载（周期、非周期）

cn.swiftpass.aia.css.task.loader.CssTaskLoader.load()

![image-20230308134147081](file://E:/wallyt/%E8%B4%A6%E6%88%B7%E7%B3%BB%E7%BB%9F%E6%A2%B3%E7%90%86/%E8%B4%A6%E6%88%B7%E4%BA%A4%E6%8E%A5/image/image-20230308134147081.png?lastModify=1690789408)

查询周期任务：

-- 周期任务  
select  
    t.TASK_ID,  
    t.PARA_ID,  
    t.TASK_NAME,  
    t.TASK_TIME,  
    t.CHECK_BILL_RESULT,  
    t.IS_CONTINUE,  
    t.RELATION_ID,  
    t.TASK_STATUS,  
    t.TASK_BEGIN_TIME,  
    t.TASK_END_TIME,  
    t.BILL_DATE,  
    t.CREATE_TIME,  
    t.PHYSICS_FLAG,  
    t.REMARK,  
    t.FLD_N1,  
    t.UPDATE_TIME,  
    t.PARTNER_ID,  
    tp.IS_PERIOD,  
    tp.PERIOD,  
    tp.BEGIN_TIME,  
    tp.END_TIME,  
    tp.PREFERMENT,  
    tp.TASK_TYPE,  
    tp.CHECK_BILL_POLICYS_ID  
from  
    CSS_TASK t  
left join CSS_TASK_PARAMETER tp on  
    tp.ID = t.PARA_ID  
where  
    t.PHYSICS_FLAG = 1  
    and t.TASK_TIME <= '2023-03-06 23:15:14.59158'  
    and tp.IS_PERIOD = 1  
    and tp.TASK_TYPE in ( 1 , 2 , 3 , 4 , 8 , 9 )  
    and tp.TERMINAL_NAME = 'dev'  
    and t.TASK_STATUS in ( 0 , 4 )  
order by t.TASK_TIME desc, tp.PREFERMENT;  
​

查询非周期任务

-- 非周期任务  
​  
select  
    t.TASK_ID,  
    t.PARA_ID,  
    t.TASK_NAME,  
    t.TASK_TIME,  
    t.CHECK_BILL_RESULT,  
    t.IS_CONTINUE,  
    t.RELATION_ID,  
    t.TASK_STATUS,  
    t.TASK_BEGIN_TIME,  
    t.TASK_END_TIME,  
    t.BILL_DATE,  
    t.CREATE_TIME,  
    t.PHYSICS_FLAG,  
    t.REMARK,  
    t.FLD_N1,  
    t.UPDATE_TIME,  
    t.PARTNER_ID,  
    tp.IS_PERIOD,  
    tp.PERIOD,  
    tp.BEGIN_TIME,  
    tp.END_TIME,  
    tp.PREFERMENT,  
    tp.TASK_TYPE,  
    tp.CHECK_BILL_POLICYS_ID  
from  
    CSS_TASK t  
left join CSS_TASK_PARAMETER tp on  
    tp.ID = t.PARA_ID  
where  
    t.PHYSICS_FLAG = 1  
    and t.TASK_TIME <= '2023-03-06 23:14:59.344077'  
    and tp.IS_PERIOD = 2  
    and tp.TASK_TYPE in ( 1 , 2 , 3 , 4 , 8 , 9 )  
    and tp.TERMINAL_NAME = 'dev'  
    and t.TASK_STATUS in ( 0 , 4 )  
order by t.TASK_TIME desc, tp.PREFERMENT;

##### 1.10.1.3.3 周期任务创建

1、查询周期任务, 小于等于当前日期时间的初始化、失败的周期任务

![image-20230308153031581](file://E:/wallyt/%E8%B4%A6%E6%88%B7%E7%B3%BB%E7%BB%9F%E6%A2%B3%E7%90%86/%E8%B4%A6%E6%88%B7%E4%BA%A4%E6%8E%A5/image/image-20230308153031581.png?lastModify=1690789408)

判断任务是否到时间

##### 1.10.1.3.4 非周期任务创建

判断任务是否到时间

没到执行时间就不加任务队列

![image-20230309121805754](file://E:/wallyt/%E8%B4%A6%E6%88%B7%E7%B3%BB%E7%BB%9F%E6%A2%B3%E7%90%86/%E8%B4%A6%E6%88%B7%E4%BA%A4%E6%8E%A5/image/image-20230309121805754.png?lastModify=1690789408)

对于创建任务（非周期任务）而言，任务创建完成后会自动滚到下一个周期，cn.swiftpass.aia.css.task.worker.CssTaskWorker#afterWork

![image-20230308151720757](file://E:/wallyt/%E8%B4%A6%E6%88%B7%E7%B3%BB%E7%BB%9F%E6%A2%B3%E7%90%86/%E8%B4%A6%E6%88%B7%E4%BA%A4%E6%8E%A5/image/image-20230308151720757.png?lastModify=1690789408)

##### 1.10.1.3.5 创建任务的工人

见 [https://www.processon.com/mindmap/64083a4fd7a4e608f6eb217c](https://www.processon.com/mindmap/64083a4fd7a4e608f6eb217c) 创建任务项

#### 1.10.1.4、注意

创建任务：

查询是否存在已创建的任务：（账单下载、对账、合作伙伴对账单、账户通道账单生成、清算任务），存在就创建失败，人工介入分析  
select  
    t.TASK_ID,  
    t.PARA_ID,  
    t.TASK_NAME,  
    t.TASK_TIME,  
    t.CHECK_BILL_RESULT,  
    t.IS_CONTINUE,  
    t.RELATION_ID,  
    t.TASK_STATUS,  
    t.TASK_BEGIN_TIME,  
    t.TASK_END_TIME,  
    t.BILL_DATE,  
    t.CREATE_TIME,  
    t.PHYSICS_FLAG,  
    t.REMARK,  
    t.FLD_N1,  
    t.UPDATE_TIME,  
    t.PARTNER_ID,  
    tp.IS_PERIOD,  
    tp.PERIOD,  
    tp.BEGIN_TIME,  
    tp.END_TIME,  
    tp.PREFERMENT,  
    tp.TASK_TYPE,  
    tp.CHECK_BILL_POLICYS_ID  
from  
    CSS_TASK t  
left join CSS_TASK_PARAMETER tp on  
    tp.ID = t.PARA_ID  
where  
    t.PHYSICS_FLAG = 1  
    and t.TASK_TIME = '2023-03-03 00:00:00.0'   【前一天的任务】task.getTaskTime().minusDays(1)  
    and t.PHYSICS_FLAG = 1  
    and tp.IS_PERIOD = 2  
    and tp.TASK_TYPE in ( 1 , 2 , 3 , 4 , 9 )  
order by  
    t.TASK_TIME desc,  
    tp.PREFERMENT;

- 1、创建任务的问题
    
- [x]  a、测试经常会有创建任务没有响应的问题

1、检查创建任务的执行时间和配置的时区（任务创建的时间都是零点触发创建的原则执行的，西时区当前时间和时区相同即表示是零点，东时区当前时间+时区=24就表示到了零点）

1.1  taskDateTime 时间的取值需要注意：

由于账户的url配置都是

此参数对于Mybatis解析时会特殊处理：

如果发送的请求是时间，当前如果是在东三区的时间，发送SQL语句中的时间会进行运算减去3个小时换算成UTC时间，存储到库中的就是UTC时间

如果是响应过来的时间，当前仍然是在东三区的时间，响应的时间字段字段会在之前的时间基础上+3个小时，转换成本地的时区时间

- [x]  b、任务有响应，但执行报错 检查是否已经创建了任务
- [x]  c、创建任务失败，显示任务已存在，状态充初始化到运行中，最后remark是任务已存在 ![image-20230308102326967](file://E:/wallyt/%E8%B4%A6%E6%88%B7%E7%B3%BB%E7%BB%9F%E6%A2%B3%E7%90%86/%E8%B4%A6%E6%88%B7%E4%BA%A4%E6%8E%A5/image/image-20230308102326967.png?lastModify=1690789408) ![image-20230308101845692](file://E:/wallyt/%E8%B4%A6%E6%88%B7%E7%B3%BB%E7%BB%9F%E6%A2%B3%E7%90%86/%E8%B4%A6%E6%88%B7%E4%BA%A4%E6%8E%A5/image/image-20230308101845692.png?lastModify=1690789408) 措施： 检查css-task中的相关accessor、parser、processor是否已经配置，配置完成后去掉已生成的对账任务，重新跑创建非周期任务

### 1.10.2、对账不相关的任务

主要是sp-task框架相关的任务。、

实现RdpBaseJob中的execute方法，将其托管到spring容器，在管理平台新增的定时任务即可。

![image-20230309133921208](file://E:/wallyt/%E8%B4%A6%E6%88%B7%E7%B3%BB%E7%BB%9F%E6%A2%B3%E7%90%86/%E8%B4%A6%E6%88%B7%E4%BA%A4%E6%8E%A5/image/image-20230309133921208.png?lastModify=1690789408)

字段含义：

![image-20230309134437200](file://E:/wallyt/%E8%B4%A6%E6%88%B7%E7%B3%BB%E7%BB%9F%E6%A2%B3%E7%90%86/%E8%B4%A6%E6%88%B7%E4%BA%A4%E6%8E%A5/image/image-20230309134437200.png?lastModify=1690789408)

sp-task框架原理

见：[https://www.tapd.cn/39147017/markdown_wikis/show/#1139147017001001076](https://www.tapd.cn/39147017/markdown_wikis/show/#1139147017001001076)

## 1.11 对账

对账任务核对的框架模板

![image-20230309143308765](file://E:/wallyt/%E8%B4%A6%E6%88%B7%E7%B3%BB%E7%BB%9F%E6%A2%B3%E7%90%86/%E8%B4%A6%E6%88%B7%E4%BA%A4%E6%8E%A5/image/image-20230309143308765.png?lastModify=1690789408)

根据对账策略分开核对，再汇聚对账结果

对账策略类图：

![image-20230309143907541](file://E:/wallyt/%E8%B4%A6%E6%88%B7%E7%B3%BB%E7%BB%9F%E6%A2%B3%E7%90%86/%E8%B4%A6%E6%88%B7%E4%BA%A4%E6%8E%A5/image/image-20230309143907541.png?lastModify=1690789408)

对账策略里面对应的Job任务，里面主要是一个业务类型的正反向交易处理，如支付、支付退款、支付冲正，一般情况都是单一的一种场景处理

![image-20230309144057124](file://E:/wallyt/%E8%B4%A6%E6%88%B7%E7%B3%BB%E7%BB%9F%E6%A2%B3%E7%90%86/%E8%B4%A6%E6%88%B7%E4%BA%A4%E6%8E%A5/image/image-20230309144057124.png?lastModify=1690789408)

### 1.11.1系统内部交易核对：

账户内部对账【生成账户标准账单】

![image-20230309141033169](file://E:/wallyt/%E8%B4%A6%E6%88%B7%E7%B3%BB%E7%BB%9F%E6%A2%B3%E7%90%86/%E8%B4%A6%E6%88%B7%E4%BA%A4%E6%8E%A5/image/image-20230309141033169.png?lastModify=1690789408)

包括充值、转账、支付、支付冲正、支付退款、充值退款，这些交易记录的标准账单文件

![image-20230309141237823](file://E:/wallyt/%E8%B4%A6%E6%88%B7%E7%B3%BB%E7%BB%9F%E6%A2%B3%E7%90%86/%E8%B4%A6%E6%88%B7%E4%BA%A4%E6%8E%A5/image/image-20230309141237823.png?lastModify=1690789408)

账户本地对账，主要核对内部交易对账。包括

![image-20230309134647929](file://E:/wallyt/%E8%B4%A6%E6%88%B7%E7%B3%BB%E7%BB%9F%E6%A2%B3%E7%90%86/%E8%B4%A6%E6%88%B7%E4%BA%A4%E6%8E%A5/image/image-20230309134647929.png?lastModify=1690789408)

账户对账策略配置，固定，不再修改。

![image-20230309141932421](file://E:/wallyt/%E8%B4%A6%E6%88%B7%E7%B3%BB%E7%BB%9F%E6%A2%B3%E7%90%86/%E8%B4%A6%E6%88%B7%E4%BA%A4%E6%8E%A5/image/image-20230309141932421.png?lastModify=1690789408)

【注意】，1、顶层的class只是个标识，没有具体的类，主要yml解析时，下面子类会被应用通过反射进行实例化。

![image-20230309142304648](file://E:/wallyt/%E8%B4%A6%E6%88%B7%E7%B3%BB%E7%BB%9F%E6%A2%B3%E7%90%86/%E8%B4%A6%E6%88%B7%E4%BA%A4%E6%8E%A5/image/image-20230309142304648.png?lastModify=1690789408)

2、对账前选择对账策略，对于具体通道的对账，优先选择通道配置的apiProvider配置的通道对账策略：

如Hyperpay对账：

![image-20230309142648127](file://E:/wallyt/%E8%B4%A6%E6%88%B7%E7%B3%BB%E7%BB%9F%E6%A2%B3%E7%90%86/%E8%B4%A6%E6%88%B7%E4%BA%A4%E6%8E%A5/image/image-20230309142648127.png?lastModify=1690789408)

具体通道的对账策略

![image-20230309142746405](file://E:/wallyt/%E8%B4%A6%E6%88%B7%E7%B3%BB%E7%BB%9F%E6%A2%B3%E7%90%86/%E8%B4%A6%E6%88%B7%E4%BA%A4%E6%8E%A5/image/image-20230309142746405.png?lastModify=1690789408)

![image-20230309142848349](file://E:/wallyt/%E8%B4%A6%E6%88%B7%E7%B3%BB%E7%BB%9F%E6%A2%B3%E7%90%86/%E8%B4%A6%E6%88%B7%E4%BA%A4%E6%8E%A5/image/image-20230309142848349.png?lastModify=1690789408)

这里主要是一个通道可能有多个交易类型，可以分任务，再根据对账策略的对应业务进行分开核对，如IBAN通道，可能有IBAN充值进来的交易以及提现进来的交易。

### 1.11.2通道对账

【生成通道标准账单、通道账单VS tcs 对账】

![image-20230309151800268](file://E:/wallyt/%E8%B4%A6%E6%88%B7%E7%B3%BB%E7%BB%9F%E6%A2%B3%E7%90%86/%E8%B4%A6%E6%88%B7%E4%BA%A4%E6%8E%A5/image/image-20230309151800268.png?lastModify=1690789408)

### 1.11.3 账户通道对账

【acs VS tcs 具体通道相关的订单】（主要是账户侧的充值、提现的订单）

1、账户通道账单生成

2、账户通道账单核对 (以Hyperpay_账户通道为例)， processorId = 7(AccountAisleOrderBillProcessor) 就是账户通道账单生成任务，根据参数的relationId生成账户通道账单

accessorId = 3 （LocalAccessor） parserId = 3 (CheckBillParser) processorId = 4(CheckBillProcessor)

![image-20230309150640195](file://E:/wallyt/%E8%B4%A6%E6%88%B7%E7%B3%BB%E7%BB%9F%E6%A2%B3%E7%90%86/%E8%B4%A6%E6%88%B7%E4%BA%A4%E6%8E%A5/image/image-20230309150640195.png?lastModify=1690789408)账户通道对账任务的对账策略；![image-20230309150753181](file://E:/wallyt/%E8%B4%A6%E6%88%B7%E7%B3%BB%E7%BB%9F%E6%A2%B3%E7%90%86/%E8%B4%A6%E6%88%B7%E4%BA%A4%E6%8E%A5/image/image-20230309150753181.png?lastModify=1690789408)

### 1.11.4 生成合作伙伴账单

当所有的对账任务完成且都对平，就生成合作伙伴账单

![image-20230309151244365](file://E:/wallyt/%E8%B4%A6%E6%88%B7%E7%B3%BB%E7%BB%9F%E6%A2%B3%E7%90%86/%E8%B4%A6%E6%88%B7%E4%BA%A4%E6%8E%A5/image/image-20230309151244365.png?lastModify=1690789408)

## 1.12 清算&&清分

### 1.12.1 账户清分

根据交易类型进行资金清算，包括手续费等，生成清分记录

清分需求：[https://www.tapd.cn/58447337/prong/stories/view/1158447337001008504](https://www.tapd.cn/58447337/prong/stories/view/1158447337001008504)

清分要求：[https://www.processon.com/diagraming/627dd267f346fb64d55f3dc5](https://www.processon.com/diagraming/627dd267f346fb64d55f3dc5)

清分梳理：[https://www.processon.com/mindmap/628702406376893bcc09baac](https://www.processon.com/mindmap/628702406376893bcc09baac)

1、清分任务配置

![image-20230309154849547](file://E:/wallyt/%E8%B4%A6%E6%88%B7%E7%B3%BB%E7%BB%9F%E6%A2%B3%E7%90%86/%E8%B4%A6%E6%88%B7%E4%BA%A4%E6%8E%A5/image/image-20230309154849547.png?lastModify=1690789408)

2、触发条件，必须通道对平

![image-20230309155023250](file://E:/wallyt/%E8%B4%A6%E6%88%B7%E7%B3%BB%E7%BB%9F%E6%A2%B3%E7%90%86/%E8%B4%A6%E6%88%B7%E4%BA%A4%E6%8E%A5/image/image-20230309155023250.png?lastModify=1690789408)

cn.swiftpass.aia.css.service.impl.clear.NewSettleAccountsServiceImpl#generateCleaningBillDetail 生成清分明细记录及资金划拨的详细信息

注意：

由于当前通道费率只支持单产品码的费率，查询时查询的是最新的一个类表，Hyperpay Fee是个虚拟的通道，所以时间要改成比其他时间都早的时间。(应该算设计问题，待处理)![image-20230309154304851](file://E:/wallyt/%E8%B4%A6%E6%88%B7%E7%B3%BB%E7%BB%9F%E6%A2%B3%E7%90%86/%E8%B4%A6%E6%88%B7%E4%BA%A4%E6%8E%A5/image/image-20230309154304851.png?lastModify=1690789408)

### 1.12.2 收单清分

收单清分文件解析生成收单的清分明细，账户交易按业务场景进行汇总生成账户清分记录

流程： 账户对完账后提供合作伙伴对账单给到钱包，钱包检查sftp是否有当天的OK对账单文件，存在就核对。核对完成后提供钱包对账单给收单，收单完成支付退款交易的对账并按商户维度出对应的清分记录（具体商户清分配置），生成清分文件，通知账户在sftp服务器上放了行内和行外的清分文件。账户取到文件解析，验证核对数据（MD5验证），将收单的清分记录入库，待结算任务查询记录结算处理。

结算任务发起后修改结算状态，由同步状态定时任务同步结算订单状态，同步完成后会生成回盘文件放置sftp，收单定时任务会定时查询回盘文件，来更新收单的清分状态。

### 1.12.3 特殊处理：

Hyperypay Fee 对账及清分处理：

见概设： [https://www.tapd.cn/58667665/markdown_wikis/show/#1158667665001004292](https://www.tapd.cn/58667665/markdown_wikis/show/#1158667665001004292)

## 1.13 结算账户划款

根据清分明细进行账户间的划款操作

![image-20230309155338080](file://E:/wallyt/%E8%B4%A6%E6%88%B7%E7%B3%BB%E7%BB%9F%E6%A2%B3%E7%90%86/%E8%B4%A6%E6%88%B7%E4%BA%A4%E6%8E%A5/image/image-20230309155338080.png?lastModify=1690789408)

### 1.13.1 行内：

包括账户内部的清分记录和收单的行内清分记录。调用anb的payment接口

1、账户清分生成的行内各账户清分记录

2、收单提供的行内清分文件清分记录

![image-20230309165427192](file://E:/wallyt/%E8%B4%A6%E6%88%B7%E7%B3%BB%E7%BB%9F%E6%A2%B3%E7%90%86/%E8%B4%A6%E6%88%B7%E4%BA%A4%E6%8E%A5/image/image-20230309165427192.png?lastModify=1690789408)

### 1.13.2 行外：

调用ANB的bulkpayment接口

![image-20230309165312530](file://E:/wallyt/%E8%B4%A6%E6%88%B7%E7%B3%BB%E7%BB%9F%E6%A2%B3%E7%90%86/%E8%B4%A6%E6%88%B7%E4%BA%A4%E6%8E%A5/image/image-20230309165312530.png?lastModify=1690789408)

### 1.13.3 状态同步：

同步行内订单清分状态和行外订单清分状态

![image-20230309165710693](file://E:/wallyt/%E8%B4%A6%E6%88%B7%E7%B3%BB%E7%BB%9F%E6%A2%B3%E7%90%86/%E8%B4%A6%E6%88%B7%E4%BA%A4%E6%8E%A5/image/image-20230309165710693.png?lastModify=1690789408)

同步批量结算的状态：

![image-20230309165836079](file://E:/wallyt/%E8%B4%A6%E6%88%B7%E7%B3%BB%E7%BB%9F%E6%A2%B3%E7%90%86/%E8%B4%A6%E6%88%B7%E4%BA%A4%E6%8E%A5/image/image-20230309165836079.png?lastModify=1690789408)

### 1.13.4 生成收单回盘文件：

获取收单侧清分成、生成回盘文件失败、回盘文件上传失败的清分批次记录, 生成清分回盘文件, 上传回盘文件至SFTP

![image-20230309170009468](file://E:/wallyt/%E8%B4%A6%E6%88%B7%E7%B3%BB%E7%BB%9F%E6%A2%B3%E7%90%86/%E8%B4%A6%E6%88%B7%E4%BA%A4%E6%8E%A5/image/image-20230309170009468.png?lastModify=1690789408)

![image-20230309170148326](file://E:/wallyt/%E8%B4%A6%E6%88%B7%E7%B3%BB%E7%BB%9F%E6%A2%B3%E7%90%86/%E8%B4%A6%E6%88%B7%E4%BA%A4%E6%8E%A5/image/image-20230309170148326.png?lastModify=1690789408)

概要设计见：

[结算清分概要设计]  ./结算清分概要设计.docx 

## 1.14 其他：

### IBAN账号规则：

IBAN账号的结构： SA countryCode CD 校验位 30100 固定数字 HHH ANB分配的合作伙伴编号 RRRRRRRRRRR 生成的索引编号 C 校验位

SACD30100HHHRRRRRRRRRRRC

![image-20230309191522136](file://E:/wallyt/%E8%B4%A6%E6%88%B7%E7%B3%BB%E7%BB%9F%E6%A2%B3%E7%90%86/%E8%B4%A6%E6%88%B7%E4%BA%A4%E6%8E%A5/image/image-20230309191522136.png?lastModify=1690789408)

[https://www.tapd.cn/69487640/prong/stories/view/1169487640001087178](https://www.tapd.cn/69487640/prong/stories/view/1169487640001087178)

当开户时，Tiqmo项目需要生成

1. 14位中台账户号
    
2. 24位IBAN号
    

这两个字段会相互映射，14位中台账号成为我们内部账户号，IBAN账号是对外的账户号用于对账，代付等

### iban账号的生成

**十一位reference no的算法**

1位业务码(默认为0，后续由中台自己调整) + 9位自增码（从166666666开始） + 1位check digit

checkdigit 计算算法：

1. 首先把所有的奇数位置(1,3, ...9)的数字相加，得到结果A
    
2. 再把偶数(2,4, ...10)位置的数字相加，得到结果B
    
3. A乘B在模除 66，如果为1位则取为check digit, 如果为两位则取最右的digit
    

例：

第一个账号

0 + 166666666 + x

1. 奇数位的和，24
    
2. 偶数位的和，25
    
3. 相乘等于 600
    
4. 600模除 66, 6
    

最后十一位为：**0 + 166666666 + 6**

![image-20230309191659149](file://E:/wallyt/%E8%B4%A6%E6%88%B7%E7%B3%BB%E7%BB%9F%E6%A2%B3%E7%90%86/%E8%B4%A6%E6%88%B7%E4%BA%A4%E6%8E%A5/image/image-20230309191659149.png?lastModify=1690789408)

假设现在已知除最后一个check digit的后15位(00800142730001?),

现在给每一个digit一个排号,也就是1-15位数，00800142730001?

1. 首先把所有的奇数位置(1,3, ...13)的数字相加
    
    (0 +8 + 0 + 4 + 7 + 0 + 0) = 19
    
2. 然后用第一步的结果乘以**3**
    
    (19 *3) = 57
    
3. 再把偶数(2,4, ...14)位置的数字相加
    
    (0 + 0 + 1 + 2 + 3 + 0 + 1) = 7
    
4. 把第二步和第三步的结果相加
    
    (57 + 7) = 64
    
5. 选择这个结果最右边的digit
    
    (64) 最右边的是 (4)
    
6. 然后用（9 减去第五步的结果）
    
    (9 - 4) = 5
    

所以第15位check digit结果是5

00800142730001? --> 00800142730001 5

### 最后一位的校验位算法

![image-20230309191813515](file://E:/wallyt/%E8%B4%A6%E6%88%B7%E7%B3%BB%E7%BB%9F%E6%A2%B3%E7%90%86/%E8%B4%A6%E6%88%B7%E4%BA%A4%E6%8E%A5/image/image-20230309191813515.png?lastModify=1690789408)

1. 把 “28”和“10”接在账号最后 ( SA的ASCII码) 还有 “00”也接在最后
    
2. 用上面的结果模除 97 (除以 97的余数)
    
3. 用 98减去结果 ，如果比 10 小在前面加一个0
    
4. 得到check digits
    

例子，目前有账号：999012345678907.

拼接后得到： 30100 999012345678907

1. 把 “28”和“10”接在账号最后 30100999012345678907 281000
    
2. 用上面的结果模除 97 (30100999012345678907281000除以 97的余数) = 78
    
3. 用 98减去结果，98 - 78 = 20
    
4. 所以结果 = 20
    
5. ![image-20230309191942133](file://E:/wallyt/%E8%B4%A6%E6%88%B7%E7%B3%BB%E7%BB%9F%E6%A2%B3%E7%90%86/%E8%B4%A6%E6%88%B7%E4%BA%A4%E6%8E%A5/image/image-20230309191942133.png?lastModify=1690789408)
    

验证IBAN号网址： [http://ibanbic.cn/](http://ibanbic.cn/)

# 2、营销梳理

[部分代码走读](营销代码走读.md)

![image-20230309171121067](file://E:/wallyt/%E8%B4%A6%E6%88%B7%E7%B3%BB%E7%BB%9F%E6%A2%B3%E7%90%86/%E8%B4%A6%E6%88%B7%E4%BA%A4%E6%8E%A5/image/image-20230309171121067.png?lastModify=1690789408)

营销改造概设：[https://www.tapd.cn/58667665/markdown_wikis/show/#1158667665001004342](https://www.tapd.cn/58667665/markdown_wikis/show/#1158667665001004342)

## 2.1 创建发行方

目前发行方，只有一个，需求见 [https://www.tapd.cn/38569350/prong/stories/view/1138569350001096689](https://www.tapd.cn/38569350/prong/stories/view/1138569350001096689)

portal操作创建发行方，会请求账户系统创建运营户、营销户、过渡户。运营户入金见【小记】

【小记】： 新开的发行方的运营账户Iban号需要使用用户提供的IBAN号的后15位替换为钱包系统内部的IBAN号，这样loyalty 在pullservice的时候就会拉取到loyalty的入金记录，根据后15位找到对应的IBAN号账户记录（只能通过脚本改），进入PullService账单记录表，然后营销的PullService定时任务拉取IBAN充值记录，做账单充值。

### 2.1.1 注意点

## 2.2 活动创建

活动创建会请求账户系统将活动预算金额从运营户转到营销户，如果活动在未开启前编辑活动就涉及到增加或减少预算，就需要从运营和营销户中进行互转。一旦开启后就不能再编辑活动预算，活动预算会跟活动走，并且活动记录余额和冻结金额。

### 2.2.1 新建&编辑订单活动

更新订单活动需要根据订单状态，处理对应的字段。如果新建或者更新未开启的活动则可以更新所有的字段信息。如果是已开启的活动只能更新非关键字段信息。其中的关键字段数据包括：活动折扣类型（包括立减和返现）活动交易优惠规则（固定、百分比），活动预算，活动时间（开始、失效、启动时间），场景，参与对象（用户、商户），消费满（消费金额需要大于此值，活动参与条件的最低消费金额，根据条件统计累计）返现/立减金额，返现/立减比例（存款都是万分比，计算订单折扣金额=（10000-discountRate）* orderAmount） 消费累计限制（用户/商户在当前时间算起的累计周期内满足最小、最大累计笔数限制）

### 2.2.2 新建邀请活动

也是根据订单状态可以修改对应的字段数据。主要是针对用户在不同场景（KYC、发生第N笔交易）下进行用户返现交易处理

## 2.3 订单活动处理

每新建活动时，已经将虚拟资金从运营户到了营销户，编辑非开启的活动，虚拟资金在两个账户间进行出入。活动启动后，活动预算就固定，活动余额=活动预算，冻结金额=0，在参与活动的交易就会从活动中扣减优惠金额。

### 2.3.1 预核销

在交易中检查活动条件，如果交易满足活动条件，检查活动余额是否够支付活动优惠金额，如果够支付就先为这个用户的交易先冻结这笔优惠金额，等用户交易成功就来解冻扣除这个金额。如果交易失败钱包可以通过预核验确认接口主动告诉营销支付失败，解冻释放这个金额到活动余额。如果不主动调用此笔金额就会暂时冻结会营销营销参与，由定时任务xxl-job orderLoyaltyAmtUnfreenOrWriteOffTaskJob任务来扫描过期订单进行解冻处理。

### 2.3.2 核验

为了系统的安全性，钱包系统调用营销的核验接口，避免交易途中订单号、交易金额变更

### 2.3.3 核销

如果命中营销活动，且用户交易已经成功，钱包侧对营销交易也处理成功就调用核销接口来从活动余额释放并扣除这笔优惠金

### 2.3.4 结算

1、如果活动结束或到期，活动剩余的活动余额还在营销户，这样会导致有余额碎片，就需要需要将活动剩余的余额再返回到运营户。

2、结算前会统计营销活动的交易发生额，核验营销的发生额 = ？ 活动预算 - 活动余额，当等于时才发生结算处理，否则等待解冻交易都解冻完成后再结算。

### 2.3. 5 退款结算

如果钱包的用户交易发生退款，优惠金额也是需要退回的。在营销侧会生成退款交易（mp_activity_refund_detail）就退款订单进行退款处理。此处和活动状态无关。

# 3、复杂业务：

1、支付+购券+营销支付（立减/返现，尝试一次，异常重试）+核销（尝试一次，异常重试）

支付+营销活动+核销 概要设计 [https://www.tapd.cn/39147017/markdown_wikis/show/#1139147017001000427](https://www.tapd.cn/39147017/markdown_wikis/show/#1139147017001000427)

2、用户支付退款+退券+退营销优惠（立减/返现，尝试一次，异常重试）+营销退优惠预算（尝试一次，异常重试）

退款+退营销： [https://www.tapd.cn/39147017/markdown_wikis/show/#1139147017001000440](https://www.tapd.cn/39147017/markdown_wikis/show/#1139147017001000440)

退优惠预算：[https://www.tapd.cn/39147017/markdown_wikis/show/#1139147017001000427](https://www.tapd.cn/39147017/markdown_wikis/show/#1139147017001000427)

3、邀请码返现

用户输入他人邀请码，完成KYC，平台给邀请人和被邀请人进行返现。

邀请码返现 [https://www.tapd.cn/39147017/markdown_wikis/show/#1139147017001000416](https://www.tapd.cn/39147017/markdown_wikis/show/#1139147017001000416)

# 4、其他梳理:

ANB提现 行内、行外

1、提现与MT940 字段的对应关系

![image-20230310172155031](file://E:/wallyt/%E8%B4%A6%E6%88%B7%E7%B3%BB%E7%BB%9F%E6%A2%B3%E7%90%86/%E8%B4%A6%E6%88%B7%E4%BA%A4%E6%8E%A5/image/image-20230310172155031.png?lastModify=1690789408)

2、清分 账户、收单

与收单相关的账户分为intermediate账户：主要是商户的结算从此账户出款，Fee账户： 通道成本（收单配置商户出），Revenue账户：fee商户的MDR

3、Hyperypay 对账 Fee对账 清算

Hyperypay 对账 —> 数据到三方表 -> hyperfee对账检查Hyperypay 对账完成，开始 Hyperypay Fee对账，对账完成后

查询css_triple_check_bill_detail对平的记录将对平的数据存到css_pending_clr_count待清分记录表中

生成从gateway账户划拨到运营账户的清分记录 生成从gateway账户划拨到运营账户的清分记录

遗留的任务：

生产上待验证：所有ANB相关交易的处理、对账 ；Hyperypay Fee对账生产数据验证；清分验证

# 5、收单

[https://www.tapd.cn/39147017/markdown_wikis/show/#1139147017001000401](https://www.tapd.cn/39147017/markdown_wikis/show/#1139147017001000401)

资料

5.1 、 处理流程：

2023-01-31 09:03:09.743 INFO [63d8af1d82f1bb00016823fc] [DubboServerHandler-10.244.6.194:20896-thread-22] cn.swiftpass.swallet.mch.service.impl.ReceiptOrderServiceImpl Line:518 - ReceiptOrderServiceImpl.receiptOrder request: {"externalGwHandle":"voucher_receipt","externalGwType":"sync","data":"<?xml version=\"1.0\" encoding=\"UTF-8\"?><xml><service><![CDATA[pay.tiqmo.app.intl]]></service><mch_id><![CDATA[101540000002]]></mch_id> <out_trade_no><![CDATA[O20230131090309008924]]></out_trade_no><nonce_str><![CDATA[v4o6qcwqePo3pDjY]]></nonce_str><body><![CDATA[ Xbox 6m Game Pass]]></body><total_fee><![CDATA[24000]]></total_fee><notify_url> [![CDATA[http://wallyt-intf-web.wallet.svc.cluster.local:9092/mchservice/mch/getReceiptNoticeMch]]](!%5BCDATA%5Bhttp://wallyt-intf-web.wallet.svc.cluster.local:9092/mchservice/mch/getReceiptNoticeMch%5D%5D)</notify_url><mch_create_ip><![CDATA[10.244.6.194]]></mch_create_ip><scene><![CDATA[15]]></scene><sign_type> <![CDATA[SHA256]]></sign_type><sign><![CDATA[FDCF536CA8F12FF573E92CC2A04D0C4CE78AF7052D2004ECA875BDF07DE48EB9]]></sign></xml>","charSet":"UTF-8", "target":"[http://acquiring-pay-main-intl.acquiring.svc.cluster.local:9000/pay/gateway](http://acquiring-pay-main-intl.acquiring.svc.cluster.local:9000/pay/gateway)","traceId":"63d8af1d82f1bb00016823fc","org":"96601","reqHeaderParam":{"signKey":"457561ff30ddad9b1e32a68cbe3e323b"},"sslNeed":false} oo 2023-01-31 09:03:09.743 DEBUG [63d8af1d82f1bb00016823fc] [DubboServerHandler-10.244.6.194:20896-thread-22] cn.swiftpass.swallet.mch.utils.SendReceiptServiceUtils Line:38 - signKey=457561ff30ddad9b1e32a68cbe3e323b

AuthGateway:

// 配置类  
@Import({AuthGatewayPlugin.class, PayGatewayPlugin.class})  
PayMainConfiguration  
//AuthGatewayPlugin 实例化  
    class AuthGatewayPlugin implements InitializingBean  
//PayGatewayPlugin 实例化        
    class PayGatewayPlugin implements InitializingBean  
​  
//路由规则配置  
  @Bean  
  public ArmeriaServerConfigurator serverConfigurator  
        List<ServerRouteConfigure> list [cn.swiftpass.plugin.paygateway.PayGatewayPlugin#authGatewayServerRouteConfigure、cn.swiftpass.plugin.authgateway.AuthGatewayPlugin#authGatewayServerRouteConfigure]  
          
      
    @Bean(name = "payGatewayServerRouteConfigure")  
    public ServerRouteConfigure authGatewayServerRouteConfigure(  
      
    @Bean(name = "authGatewayServerRouteConfigure")  
    public ServerRouteConfigure authGatewayServerRouteConfigure() {  
    

![image-20230313170325410](file://E:/wallyt/%E8%B4%A6%E6%88%B7%E7%B3%BB%E7%BB%9F%E6%A2%B3%E7%90%86/%E8%B4%A6%E6%88%B7%E4%BA%A4%E6%8E%A5/image/image-20230313170325410.png?lastModify=1690789408)

PayGateway:

![image-20230313170644215](file://E:/wallyt/%E8%B4%A6%E6%88%B7%E7%B3%BB%E7%BB%9F%E6%A2%B3%E7%90%86/%E8%B4%A6%E6%88%B7%E4%BA%A4%E6%8E%A5/image/image-20230313170644215.png?lastModify=1690789408)

auth 完成后会进行pay的下单处理：

![image-20230313172019837](file://E:/wallyt/%E8%B4%A6%E6%88%B7%E7%B3%BB%E7%BB%9F%E6%A2%B3%E7%90%86/%E8%B4%A6%E6%88%B7%E4%BA%A4%E6%8E%A5/image/image-20230313172019837.png?lastModify=1690789408)

![image-20230313172653210](file://E:/wallyt/%E8%B4%A6%E6%88%B7%E7%B3%BB%E7%BB%9F%E6%A2%B3%E7%90%86/%E8%B4%A6%E6%88%B7%E4%BA%A4%E6%8E%A5/image/image-20230313172653210.png?lastModify=1690789408)

![image-20230313172906780](file://E:/wallyt/%E8%B4%A6%E6%88%B7%E7%B3%BB%E7%BB%9F%E6%A2%B3%E7%90%86/%E8%B4%A6%E6%88%B7%E4%BA%A4%E6%8E%A5/image/image-20230313172906780.png?lastModify=1690789408)

大商户不能发起交易??????