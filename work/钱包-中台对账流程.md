# Wallyt-Recon å¯¹è´¦ç³»ç»Ÿæ¶æ„å…¨é¢åˆ†ææŠ¥å‘Š

  

## ğŸ“‹ ç›®å½•

- [ç³»ç»Ÿæ¦‚è¿°](#ç³»ç»Ÿæ¦‚è¿°)

- [ç³»ç»Ÿæ•´ä½“æ¶æ„](#ç³»ç»Ÿæ•´ä½“æ¶æ„)

- [ä¸»è¦ä¸šåŠ¡æµç¨‹](#ä¸»è¦ä¸šåŠ¡æµç¨‹)

- [çº¿ç¨‹æ± æ¶æ„åˆ†æ](#çº¿ç¨‹æ± æ¶æ„åˆ†æ)

- [ç³»ç»Ÿç‰¹ç‚¹åˆ†æ](#ç³»ç»Ÿç‰¹ç‚¹åˆ†æ)

- [é—®é¢˜è¯†åˆ«ä¸æ”¹è¿›å»ºè®®](#é—®é¢˜è¯†åˆ«ä¸æ”¹è¿›å»ºè®®)

- [æ”¹è¿›è·¯çº¿å›¾](#æ”¹è¿›è·¯çº¿å›¾)

  

## ğŸ¯ ç³»ç»Ÿæ¦‚è¿°

  

Wallyt-Recon æ˜¯ä¸€ä¸ªåŸºäºå¾®æœåŠ¡æ¶æ„çš„é‡‘èå¯¹è´¦ç³»ç»Ÿï¼Œä¸»è¦è´Ÿè´£å¤„ç†ç¬¬ä¸‰æ–¹æ”¯ä»˜æœºæ„çš„è´¦å•ä¸‹è½½ã€æ•°æ®è§£æå’Œå¯¹è´¦å¤„ç†ã€‚ç³»ç»Ÿé‡‡ç”¨ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼ï¼Œé€šè¿‡å¤šçº¿ç¨‹å¹¶å‘å¤„ç†æ¥æé«˜å¯¹è´¦æ•ˆç‡ã€‚

  

### æ ¸å¿ƒåŠŸèƒ½

- **è´¦å•ä¸‹è½½**: ä»SFTP/FTPæœåŠ¡å™¨ä¸‹è½½ç¬¬ä¸‰æ–¹è´¦å•æ–‡ä»¶

- **æ•°æ®è§£æ**: è§£æå„ç§æ ¼å¼çš„è´¦å•æ–‡ä»¶

- **å¯¹è´¦å¤„ç†**: æ¯”å¯¹æœ¬åœ°äº¤æ˜“æ•°æ®ä¸ç¬¬ä¸‰æ–¹è´¦å•æ•°æ®

- **ç»“æœç®¡ç†**: ç”Ÿæˆå¯¹è´¦æŠ¥å‘Šå’Œå·®å¼‚å¤„ç†

  

## ğŸ—ï¸ ç³»ç»Ÿæ•´ä½“æ¶æ„

  

### æ¨¡å—åˆ’åˆ†

```mermaid

graph TB

Â  Â  A[wallyt-recon-facade<br/>é—¨é¢å±‚] --> B[wallyt-recon-service<br/>æœåŠ¡å±‚]

Â  Â  C[wallyt-recon-download<br/>ä¸‹è½½åº”ç”¨] --> D[wallyt-recon-common<br/>å…¬å…±ç»„ä»¶]

Â  Â  E[wallyt-recon-task<br/>å¯¹è´¦åº”ç”¨] --> D

Â  Â  B --> D

Â  Â  subgraph "å¾®æœåŠ¡æ¶æ„è¯¦æƒ…"

Â  Â  Â  Â  F[ğŸŒ ReconServiceApplication<br/>- DubboæœåŠ¡æä¾›è€…<br/>- æ•°æ®åº“æ“ä½œ<br/>- ä¸šåŠ¡é€»è¾‘å¤„ç†]

Â  Â  Â  Â  G[â¬‡ï¸ ReconDownloadApplication<br/>- è´¦å•ä¸‹è½½æœåŠ¡<br/>- SFTP/FTPæ¥å…¥<br/>- æ–‡ä»¶ç®¡ç†]

Â  Â  Â  Â  H[âš–ï¸ ReconTaskApplication<br/>- å¯¹è´¦ä»»åŠ¡å¤„ç†<br/>- æ•°æ®æ¯”å¯¹<br/>- ç»“æœç”Ÿæˆ]

Â  Â  end

Â  Â  B -.-> F

Â  Â  C -.-> G Â 

Â  Â  E -.-> H

```

  

### æ¨¡å—èŒè´£è¯´æ˜

  

| æ¨¡å—                        | èŒè´£     | å…³é”®ç»„ä»¶              |
| ------------------------- | ------ | ----------------- |
| **wallyt-recon-facade**   | å¯¹å¤–æ¥å£é—¨é¢ | DTOã€å¸¸é‡ã€æœåŠ¡æ¥å£å®šä¹‰     |
| **wallyt-recon-service**  | æ ¸å¿ƒä¸šåŠ¡æœåŠ¡ | ä¸šåŠ¡é€»è¾‘ã€æ•°æ®è®¿é—®ã€DubboæœåŠ¡ |
| **wallyt-recon-download** | è´¦å•ä¸‹è½½æœåŠ¡ | SFTPè®¿é—®å™¨ã€æ–‡ä»¶ä¸‹è½½å™¨     |
| **wallyt-recon-task**     | å¯¹è´¦ä»»åŠ¡å¤„ç† | å¯¹è´¦é€»è¾‘ã€æ•°æ®æ¯”å¯¹         |
| **wallyt-recon-common**   | å…¬å…±ç»„ä»¶åº“  | é˜Ÿåˆ—ã€è§¦å‘å™¨ã€å·¥ä½œè€…æ¡†æ¶      |

  

### æ ¸å¿ƒç»„ä»¶æ¶æ„

```mermaid

graph TD

Â  Â  subgraph "ä¸‹è½½å­ç³»ç»Ÿ"

Â  Â  Â  Â  A1[DownBillTaskLoader<br/>ä¸‹è½½ä»»åŠ¡ç”Ÿäº§è€…] --> A2[TaskQueue<br/>ä»»åŠ¡é˜Ÿåˆ—]

Â  Â  Â  Â  A2 --> A3[DownBillTaskTrigger<br/>ä¸‹è½½ä»»åŠ¡æ¶ˆè´¹è€…]

Â  Â  Â  Â  A3 --> A4[DownBillTaskWorker<br/>ä¸‹è½½å·¥ä½œè€…]

Â  Â  Â  Â  A4 --> A5[MiddleSFTPAccessor<br/>SFTPè®¿é—®å™¨]

Â  Â  Â  Â  A4 --> A6[MiddleSFTPParser<br/>æ–‡ä»¶è§£æå™¨]

Â  Â  end

Â  Â  subgraph "å¯¹è´¦å­ç³»ç»Ÿ"

Â  Â  Â  Â  B1[CheckBillTaskLoader<br/>å¯¹è´¦ä»»åŠ¡ç”Ÿäº§è€…] --> B2[TaskQueue<br/>ä»»åŠ¡é˜Ÿåˆ—]

Â  Â  Â  Â  B2 --> B3[CheckBillTaskTrigger<br/>å¯¹è´¦ä»»åŠ¡æ¶ˆè´¹è€…]

Â  Â  Â  Â  B3 --> B4[CheckBillTaskWorker<br/>å¯¹è´¦å·¥ä½œè€…]

Â  Â  Â  Â  B4 --> B5[æ•°æ®è®¿é—®å™¨]

Â  Â  Â  Â  B4 --> B6[æ•°æ®è§£æå™¨]

Â  Â  end

Â  Â  subgraph "çº¿ç¨‹æ± ä½“ç³»"

Â  Â  Â  Â  C1[FixedThreadPool<br/>å›ºå®šçº¿ç¨‹æ± ]

Â  Â  Â  Â  C2[CompletionService<br/>å¼‚æ­¥ç»“æœè·å–]

Â  Â  Â  Â  C3[Listener Thread<br/>ç»“æœç›‘å¬å™¨]

Â  Â  end

Â  Â  A3 -.-> C1

Â  Â  B3 -.-> C1

Â  Â  C2 --> C3

```

  

## ğŸ”„ ä¸»è¦ä¸šåŠ¡æµç¨‹

  

### 1. è´¦å•ä¸‹è½½æµç¨‹

```mermaid

sequenceDiagram

Â  Â  participant DL as DownBillTaskLoader

Â  Â  participant Q as TaskQueue Â 

Â  Â  participant DT as DownBillTaskTrigger

Â  Â  participant DW as DownBillTaskWorker

Â  Â  participant SFTP as SFTPæœåŠ¡å™¨

Â  Â  participant DB as æ•°æ®åº“

Â  Â  Note over DL: æ¯30ç§’è½®è¯¢

Â  Â  DL->>DB: æŸ¥è¯¢å¾…ä¸‹è½½ä»»åŠ¡

Â  Â  DL->>Q: æŠ•é€’ä»»åŠ¡åˆ°é˜Ÿåˆ—

Â  Â  DT->>Q: æ¶ˆè´¹é˜Ÿåˆ—ä»»åŠ¡

Â  Â  DT->>DW: åˆ›å»ºå·¥ä½œè€…çº¿ç¨‹

Â  Â  DW->>SFTP: è¿æ¥å¹¶ä¸‹è½½è´¦å•

Â  Â  DW->>DW: è§£æè´¦å•æ–‡ä»¶

Â  Â  DW->>DB: æ›´æ–°ä»»åŠ¡çŠ¶æ€

```

  

#### ä¸‹è½½æµç¨‹å…³é”®æ­¥éª¤

1. **ä»»åŠ¡æ‰«æ**: DownBillTaskLoaderæ¯30ç§’è½®è¯¢æ•°æ®åº“ï¼ŒæŸ¥æ‰¾å¾…ä¸‹è½½ä»»åŠ¡

2. **ä»»åŠ¡è¿‡æ»¤**: æ£€æŸ¥ä»»åŠ¡çŠ¶æ€ã€é‡å¤æ€§ã€æš‚åœçŠ¶æ€ç­‰

3. **åˆ†å¸ƒå¼é”**: ä½¿ç”¨Redisé”ç¡®ä¿é›†ç¾¤ç¯å¢ƒä¸‹ä»»åŠ¡å”¯ä¸€æ€§

4. **é˜Ÿåˆ—æŠ•é€’**: ç¬¦åˆæ¡ä»¶çš„ä»»åŠ¡æŠ•é€’åˆ°TaskQueue

5. **å¼‚æ­¥æ‰§è¡Œ**: DownBillTaskTriggeræ¶ˆè´¹ä»»åŠ¡å¹¶æäº¤ç»™çº¿ç¨‹æ± 

6. **æ–‡ä»¶ä¸‹è½½**: DownBillTaskWorkeré€šè¿‡SFTPä¸‹è½½è´¦å•æ–‡ä»¶

7. **çŠ¶æ€æ›´æ–°**: æ›´æ–°ä»»åŠ¡çŠ¶æ€å¹¶å¤„ç†æ‰§è¡Œç»“æœ

  

### 2. å¯¹è´¦å¤„ç†æµç¨‹

```mermaid

sequenceDiagram

Â  Â  participant CL as CheckBillTaskLoader

Â  Â  participant Q as TaskQueue

Â  Â  participant CT as CheckBillTaskTrigger Â 

Â  Â  participant CW as CheckBillTaskWorker

Â  Â  participant DB as æ•°æ®åº“

Â  Â  participant File as æœ¬åœ°æ–‡ä»¶

Â  Â  Note over CL: æ¯30ç§’è½®è¯¢

Â  Â  CL->>DB: æŸ¥è¯¢å¾…å¯¹è´¦ä»»åŠ¡

Â  Â  CL->>Q: æŠ•é€’ä»»åŠ¡åˆ°é˜Ÿåˆ—

Â  Â  CT->>Q: æ¶ˆè´¹é˜Ÿåˆ—ä»»åŠ¡

Â  Â  CT->>CW: åˆ›å»ºå·¥ä½œè€…çº¿ç¨‹

Â  Â  CW->>File: è¯»å–ç¬¬ä¸‰æ–¹è´¦å•

Â  Â  CW->>DB: æŸ¥è¯¢æœ¬åœ°äº¤æ˜“æ•°æ®

Â  Â  CW->>CW: æ‰§è¡Œå¯¹è´¦é€»è¾‘

Â  Â  CW->>DB: ä¿å­˜å¯¹è´¦ç»“æœ

```

  

#### å¯¹è´¦æµç¨‹å…³é”®æ­¥éª¤

1. **ä»»åŠ¡æ‰«æ**: CheckBillTaskLoaderè½®è¯¢å¾…å¯¹è´¦ä»»åŠ¡

2. **å‰ç½®æ£€æŸ¥**: éªŒè¯ç¬¬ä¸‰æ–¹è´¦å•æ–‡ä»¶æ˜¯å¦å­˜åœ¨

3. **æ•°æ®åº“é”**: ä½¿ç”¨æ•°æ®åº“é”é˜²æ­¢ä»»åŠ¡é‡å¤æ‰§è¡Œ

4. **æ•°æ®è¯»å–**: è¯»å–ç¬¬ä¸‰æ–¹è´¦å•å’Œæœ¬åœ°äº¤æ˜“æ•°æ®

5. **å¯¹è´¦æ¯”å¯¹**: æ‰§è¡Œå…·ä½“çš„å¯¹è´¦ä¸šåŠ¡é€»è¾‘

6. **ç»“æœä¿å­˜**: ç”Ÿæˆå¯¹è´¦ç»“æœå¹¶æŒä¹…åŒ–

  

### 3. å®Œæ•´ç³»ç»Ÿäº¤äº’æµç¨‹

```mermaid

graph LR

Â  Â  subgraph "æ•°æ®æº"

Â  Â  Â  Â  DB[(æ•°æ®åº“<br/>BillTask)]

Â  Â  Â  Â  SFTP[SFTPæœåŠ¡å™¨<br/>ç¬¬ä¸‰æ–¹è´¦å•]

Â  Â  end

Â  Â  subgraph "ä¸‹è½½æµç¨‹"

Â  Â  Â  Â  DL[DownBillTaskLoader] --> DQ[ä¸‹è½½ä»»åŠ¡é˜Ÿåˆ—]

Â  Â  Â  Â  DQ --> DT[DownBillTaskTrigger]

Â  Â  Â  Â  DT --> DW[DownBillTaskWorker]

Â  Â  Â  Â  DW --> SFTP

Â  Â  Â  Â  DW --> LocalFile[æœ¬åœ°è´¦å•æ–‡ä»¶]

Â  Â  end

Â  Â  subgraph "å¯¹è´¦æµç¨‹"

Â  Â  Â  Â  CL[CheckBillTaskLoader] --> CQ[å¯¹è´¦ä»»åŠ¡é˜Ÿåˆ—]

Â  Â  Â  Â  CQ --> CT[CheckBillTaskTrigger]

Â  Â  Â  Â  CT --> CW[CheckBillTaskWorker]

Â  Â  Â  Â  CW --> LocalFile

Â  Â  Â  Â  CW --> Result[(å¯¹è´¦ç»“æœ)]

Â  Â  end

Â  Â  DB --> DL

Â  Â  DB --> CL

Â  Â  Result --> DB

Â  Â  style DB fill:#e1f5fe

Â  Â  style SFTP fill:#fff3e0

Â  Â  style LocalFile fill:#f3e5f5

Â  Â  style Result fill:#e8f5e8

```

  

## ğŸ§µ çº¿ç¨‹æ± æ¶æ„åˆ†æ

  

### çº¿ç¨‹æ± ç»„ä»¶è¯¦è§£

  

#### 1. **TaskTriggeræ ¸å¿ƒçº¿ç¨‹æ± **

```java

// çº¿ç¨‹æ± åˆå§‹åŒ–

private void initialize() {

Â  Â  // åˆ›å»ºå›ºå®šå¤§å°çº¿ç¨‹æ± 

Â  Â  threadPool = Executors.newFixedThreadPool(maxRunningTaskNum);

Â  Â  // åŒ…è£…ä¸ºCompletionServiceï¼Œä¾¿äºå¼‚æ­¥è·å–ç»“æœ

Â  Â  service = new ExecutorCompletionService<TaskFuture>(threadPool);

Â  Â  // å¯åŠ¨ç»“æœç›‘å¬å™¨çº¿ç¨‹ï¼ˆå®ˆæŠ¤çº¿ç¨‹ï¼‰

Â  Â  listener = new Listener(this.taskQueue);

Â  Â  listener.setDaemon(true);

Â  Â  listener.start();

}

```

  

#### 2. **ä»»åŠ¡æ‰§è¡Œæ¨¡å‹**

```java

// ä»»åŠ¡æäº¤

while (true) {

Â  Â  BillTaskDto task = this.taskQueue.peek();

Â  Â  if (task != null && canExecute(task)) {

Â  Â  Â  Â  service.submit(getTaskWorker(task));

Â  Â  Â  Â  this.taskQueue.poll();

Â  Â  }

Â  Â  Thread.sleep(1000L);

}

```

  

#### 3. **ç»“æœç›‘å¬æœºåˆ¶**

```java

// Listenerçº¿ç¨‹ç›‘å¬ä»»åŠ¡å®Œæˆ

class Listener extends Thread {

Â  Â  public void run() {

Â  Â  Â  Â  while (true) {

Â  Â  Â  Â  Â  Â  Future<TaskFuture> future = service.take(); // é˜»å¡è·å–ç»“æœ

Â  Â  Â  Â  Â  Â  TaskFuture result = future.get();

Â  Â  Â  Â  Â  Â  processResult(result); // å¤„ç†æ‰§è¡Œç»“æœ

Â  Â  Â  Â  Â  Â  cleanupTask(result.getTask()); // æ¸…ç†ä»»åŠ¡çŠ¶æ€

Â  Â  Â  Â  }

Â  Â  }

}

```

  

### çº¿ç¨‹æ± é…ç½®å‚æ•°

  

| å‚æ•° | ä¸‹è½½æœåŠ¡ | å¯¹è´¦æœåŠ¡ | è¯´æ˜ |

|------|----------|----------|------|

| **é˜Ÿåˆ—å¤§å°** | 8 (å¯é…ç½®) | 1 (å›ºå®š) | ä¸‹è½½æœåŠ¡é˜Ÿåˆ—è¾ƒå¤§ï¼Œå¯¹è´¦æœåŠ¡é˜²æ­¢æŠ¢å  |

| **çº¿ç¨‹æ•°** | 8 (å¯é…ç½®) | 10 (å¯é…ç½®) | å¯¹è´¦æœåŠ¡çº¿ç¨‹æ•°è¾ƒå¤š |

| **æš‚åœæ—¶é—´** | 5åˆ†é’Ÿ | 5åˆ†é’Ÿ | ä»»åŠ¡å¤±è´¥åçš„æš‚åœé‡è¯•æ—¶é—´ |

  

## âš¡ ç³»ç»Ÿç‰¹ç‚¹åˆ†æ

  

### âœ… ä¼˜åŠ¿ç‰¹ç‚¹

  

#### 1. **å¾®æœåŠ¡æ¶æ„**

- **æœåŠ¡æ‹†åˆ†**: ä¸‹è½½å’Œå¯¹è´¦æœåŠ¡ç‹¬ç«‹éƒ¨ç½²

- **èŒè´£æ¸…æ™°**: æ¯ä¸ªæœåŠ¡ä¸“æ³¨ç‰¹å®šä¸šåŠ¡é¢†åŸŸ

- **æŠ€æœ¯æ ˆ**: Spring Boot + Dubbo + MyBatis

  

#### 2. **ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼**

- **è§£è€¦è®¾è®¡**: ä»»åŠ¡ç”Ÿäº§ä¸æ¶ˆè´¹åˆ†ç¦»

- **å¼‚æ­¥å¤„ç†**: æé«˜ç³»ç»Ÿååé‡

- **è´Ÿè½½å‡è¡¡**: å¤šæ¶ˆè´¹è€…å¹¶å‘å¤„ç†

  

#### 3. **å¤šçº¿ç¨‹å¹¶å‘**

- **çº¿ç¨‹æ± **: ä½¿ç”¨ExecutorServiceç®¡ç†å·¥ä½œçº¿ç¨‹

- **å¼‚æ­¥ç»“æœ**: CompletionServiceè·å–ä»»åŠ¡ç»“æœ

- **å¹¶å‘æ§åˆ¶**: é™åˆ¶æœ€å¤§å¹¶å‘ä»»åŠ¡æ•°

  

#### 4. **å®¹é”™æœºåˆ¶**

- **å¤±è´¥é‡è¯•**: ä»»åŠ¡å¤±è´¥åè‡ªåŠ¨æš‚åœé‡è¯•

- **çŠ¶æ€ç®¡ç†**: è¯¦ç»†çš„ä»»åŠ¡çŠ¶æ€è·Ÿè¸ª

- **å¼‚å¸¸å¤„ç†**: åˆ†å±‚å¼‚å¸¸å¤„ç†æœºåˆ¶

  

#### 5. **åˆ†å¸ƒå¼åè°ƒ**

- **æ•°æ®åº“é”**: é˜²æ­¢ä»»åŠ¡é‡å¤æ‰§è¡Œ

- **Redisé”**: é›†ç¾¤ç¯å¢ƒä¸‹çš„åˆ†å¸ƒå¼é”

- **çŠ¶æ€åŒæ­¥**: ä»»åŠ¡çŠ¶æ€å®æ—¶åŒæ­¥

  

### ğŸ“‹ æ¶æ„å±‚æ¬¡

```

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”

â”‚ Â  Â  Â  Â  Â  Â åº”ç”¨å¯åŠ¨å±‚ Â  Â  Â  Â  Â  Â  Â  Â  Â  Â â”‚

â”‚ Â ReconServiceApplication Â  Â  Â  Â  Â  Â  Â  Â â”‚

â”‚ Â ReconDownloadApplication Â  Â  Â  Â  Â  Â  Â â”‚ Â 

â”‚ Â ReconTaskApplication Â  Â  Â  Â  Â  Â  Â  Â  Â â”‚

â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤

â”‚ Â  Â  Â  Â  Â  Â ä»»åŠ¡è°ƒåº¦å±‚ Â  Â  Â  Â  Â  Â  Â  Â  Â  Â â”‚

â”‚ Â TaskRunner â†’ TaskLoader â†’ TaskTrigger Â â”‚

â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤

â”‚ Â  Â  Â  Â  Â  Â é˜Ÿåˆ—ç®¡ç†å±‚ Â  Â  Â  Â  Â  Â  Â  Â  Â  Â â”‚

â”‚ Â TaskQueue (ArrayBlockingQueue) Â  Â  Â  Â â”‚

â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤

â”‚ Â  Â  Â  Â  Â  Â çº¿ç¨‹æ‰§è¡Œå±‚ Â  Â  Â  Â  Â  Â  Â  Â  Â  Â â”‚

â”‚ Â FixedThreadPool + CompletionService Â  â”‚

â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤

â”‚ Â  Â  Â  Â  Â  Â ä¸šåŠ¡å¤„ç†å±‚ Â  Â  Â  Â  Â  Â  Â  Â  Â  Â â”‚

â”‚ Â TaskWorker â†’ Accessor â†’ Parser Â  Â  Â  Â â”‚

â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤

â”‚ Â  Â  Â  Â  Â  Â æ•°æ®è®¿é—®å±‚ Â  Â  Â  Â  Â  Â  Â  Â  Â  Â â”‚

â”‚ Â Database + SFTP + File System Â  Â  Â  Â  â”‚

â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

```

  

## ğŸš¨ é—®é¢˜è¯†åˆ«ä¸æ”¹è¿›å»ºè®®

  

### 1. æ¶æ„è®¾è®¡é—®é¢˜

  

#### ğŸ”´ **ä¸¥é‡é—®é¢˜ï¼šè½®è¯¢æ•ˆç‡ä½ä¸‹**

**é—®é¢˜æè¿°**:

```java

// âŒ å½“å‰å®ç°ï¼šæ•°æ®åº“è½®è¯¢

while (true) {

Â  Â  List<BillTaskDto> tasks = queryPendingTasks();

Â  Â  if (tasks.isEmpty()) {

Â  Â  Â  Â  Thread.sleep(30_000); // ç©ºè½®è¯¢æµªè´¹èµ„æº

Â  Â  Â  Â  continue;

Â  Â  }

}

```

  

**æ”¹è¿›å»ºè®®**:

```java

// âœ… å»ºè®®ï¼šä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—

@RabbitListener(queues = "recon.task.queue")

public void processTask(BillTaskDto task) {

Â  Â  // äº‹ä»¶é©±åŠ¨å¤„ç†

}

```

  

**ä¼˜åŠ¿**:

- æ¶ˆé™¤ç©ºè½®è¯¢ï¼ŒèŠ‚çœCPUèµ„æº

- å®æ—¶å“åº”ï¼Œå‡å°‘å¤„ç†å»¶è¿Ÿ

- æ›´å¥½çš„æ‰©å±•æ€§å’Œå¯é æ€§

  

#### ğŸ”´ **ä¸¥é‡é—®é¢˜ï¼šå¹¶å‘å®‰å…¨é—®é¢˜**

**é—®é¢˜æè¿°**:

```java

// âŒ éçº¿ç¨‹å®‰å…¨çš„å…±äº«çŠ¶æ€

public Set<String> runningOrgSet; // å¯èƒ½å¯¼è‡´æ•°æ®ä¸ä¸€è‡´

public volatile Map<String, Date> suspendTaskMap; // volatileæ— æ³•ä¿è¯å¤åˆæ“ä½œåŸå­æ€§

```

  

**æ”¹è¿›å»ºè®®**:

```java

// âœ… ä½¿ç”¨çº¿ç¨‹å®‰å…¨é›†åˆ

public Set<String> runningOrgSet = ConcurrentHashMap.newKeySet();

public ConcurrentHashMap<String, Date> suspendTaskMap = new ConcurrentHashMap<>();

```

  

### 2. æ€§èƒ½ä¼˜åŒ–é—®é¢˜

  

#### ğŸŸ¡ **çº¿ç¨‹æ± é…ç½®ä¸åˆç†**

**é—®é¢˜åˆ†æ**:

- å›ºå®šçº¿ç¨‹æ± æ— æ³•åŠ¨æ€ä¼¸ç¼©

- é˜Ÿåˆ—å¤§å°é™åˆ¶å¯èƒ½å¯¼è‡´é˜»å¡

- ç¼ºä¹æ‹’ç»ç­–ç•¥å¤„ç†

  

**æ”¹è¿›æ–¹æ¡ˆ**:

```java

// âœ… å»ºè®®ï¼šå¯ä¼¸ç¼©çº¿ç¨‹æ± 

ThreadPoolExecutor executor = new ThreadPoolExecutor(

Â  Â  corePoolSize, Â  Â  Â  Â  Â  Â  Â  Â  Â  Â // æ ¸å¿ƒçº¿ç¨‹æ•°ï¼šCPUæ ¸æ•°

Â  Â  maximumPoolSize, Â  Â  Â  Â  Â  Â  Â  Â  // æœ€å¤§çº¿ç¨‹æ•°ï¼šCPUæ ¸æ•°*2

Â  Â  60L, Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â // ç©ºé—²å­˜æ´»æ—¶é—´

Â  Â  TimeUnit.SECONDS,

Â  Â  new ArrayBlockingQueue<>(queueSize), // æœ‰ç•Œé˜Ÿåˆ—

Â  Â  new ThreadFactoryBuilder()

Â  Â  Â  Â  .setNameFormat("recon-worker-%d")

Â  Â  Â  Â  .setDaemon(false)

Â  Â  Â  Â  .setUncaughtExceptionHandler(

Â  Â  Â  Â  Â  Â  (t, e) -> logger.error("çº¿ç¨‹å¼‚å¸¸", e))

Â  Â  Â  Â  .build(),

Â  Â  new ThreadPoolExecutor.CallerRunsPolicy() // è°ƒç”¨è€…è¿è¡Œç­–ç•¥

);

```

  

#### ğŸŸ¡ **é˜Ÿåˆ—å®¹é‡é…ç½®é—®é¢˜**

**é—®é¢˜å¯¹æ¯”**:

| æœåŠ¡ç±»å‹ | å½“å‰é…ç½® | å»ºè®®é…ç½® | ç†ç”± |

|---------|---------|---------|------|

| ä¸‹è½½æœåŠ¡ | é˜Ÿåˆ—å¤§å°8 | é˜Ÿåˆ—å¤§å°16-32 | ä¸‹è½½ä»»åŠ¡IOå¯†é›†ï¼Œå¯é€‚å½“å¢å¤§é˜Ÿåˆ— |

| å¯¹è´¦æœåŠ¡ | é˜Ÿåˆ—å¤§å°1 | é˜Ÿåˆ—å¤§å°8-16 | è¿‡å°çš„é˜Ÿåˆ—å½±å“ååé‡ |

  

### 3. å¯é æ€§é—®é¢˜

  

#### ğŸŸ¡ **å¼‚å¸¸å¤„ç†ä¸å¤Ÿå®Œå–„**

**é—®é¢˜ä»£ç **:

```java

// âŒ é—®é¢˜ï¼šå¼‚å¸¸å¤„ç†è¿‡äºç²—ç³™

} catch (Exception e) {

Â  Â  logger.error("ä»»åŠ¡åŠ è½½å¼‚å¸¸", e);

Â  Â  continue; // å¯èƒ½å¯¼è‡´ä»»åŠ¡ä¸¢å¤±æˆ–çŠ¶æ€ä¸ä¸€è‡´

}

```

  

**æ”¹è¿›æ–¹æ¡ˆ**:

```java

// âœ… åˆ†ç±»å¼‚å¸¸å¤„ç†

} catch (InterruptedException e) {

Â  Â  Thread.currentThread().interrupt();

Â  Â  logger.warn("ä»»åŠ¡åŠ è½½è¢«ä¸­æ–­ï¼Œå‡†å¤‡é€€å‡º", e);

Â  Â  break;

} catch (SQLException e) {

Â  Â  logger.error("æ•°æ®åº“è®¿é—®å¼‚å¸¸ï¼Œç­‰å¾…é‡è¯•", e);

Â  Â  circuitBreaker.recordException(e);

Â  Â  Thread.sleep(getBackoffDelay());

} catch (ConnectException e) {

Â  Â  logger.error("ç½‘ç»œè¿æ¥å¼‚å¸¸", e);

Â  Â  notifyAlarm("ç½‘ç»œè¿æ¥å¤±è´¥", e);

Â  Â  Thread.sleep(60_000);

} catch (Exception e) {

Â  Â  logger.error("æœªçŸ¥å¼‚å¸¸", e);

Â  Â  errorCounter.increment();

}

```

  

#### ğŸŸ¡ **ç¼ºä¹ç›‘æ§å’ŒæŒ‡æ ‡**

**å»ºè®®æ·»åŠ ç›‘æ§**:

```java

// âœ… ç›‘æ§æŒ‡æ ‡

@Component

public class ReconMetrics {

Â  Â  private final MeterRegistry meterRegistry;

Â  Â  // ä»»åŠ¡å¤„ç†è®¡æ•°å™¨

Â  Â  private final Counter taskProcessedCounter;

Â  Â  // é˜Ÿåˆ—å¤§å°æŒ‡æ ‡

Â  Â  private final Gauge queueSizeGauge;

Â  Â  // ä»»åŠ¡æ‰§è¡Œæ—¶é—´

Â  Â  private final Timer taskExecutionTimer;

Â  Â  @ManagedAttribute

Â  Â  public int getQueueSize() { return taskQueue.size(); }

Â  Â  @ManagedAttribute

Â  Â  public int getRunningTaskCount() { return taskQueue.runningTaskNum(); }

Â  Â  @ManagedAttribute

Â  Â  public double getTaskSuccessRate() { return successRate.get(); }

}

```

  

### 4. ä»£ç è´¨é‡é—®é¢˜

  

#### ğŸŸ¡ **é…ç½®ç¡¬ç¼–ç é—®é¢˜**

**é—®é¢˜ä¸è§£å†³**:

```java

// âŒ ç¡¬ç¼–ç 

Thread.sleep(1000L * 30);

  

// âœ… é…ç½®åŒ–

@ConfigurationProperties(prefix = "recon.task")

@Data

public class ReconTaskProperties {

Â  Â  private int pollIntervalSeconds = 30;

Â  Â  private int maxRetryCount = 3;

Â  Â  private int suspendMinutes = 5;

}

```

  

#### ğŸŸ¡ **å·¥å‚ç±»è®¾è®¡é—®é¢˜**

**é—®é¢˜ä»£ç **:

```java

// âŒ è¿”å›nullçš„å±é™©å®ç°

@Override

public Accessor getMyAccessor(BillTaskDto task) {

Â  Â  return null; // å¯èƒ½å¯¼è‡´NullPointerException

}

```

  

**æ”¹è¿›æ–¹æ¡ˆ**:

```java

// âœ… ç­–ç•¥æ¨¡å¼ + ç©ºå¯¹è±¡æ¨¡å¼

@Component

public class TaskWorkerFactory {

Â  Â  private final Map<TaskType, TaskWorkerGenerator> generators;

Â  Â  public TaskWorker createWorker(BillTaskDto task) {

Â  Â  Â  Â  TaskType taskType = TaskType.fromTask(task);

Â  Â  Â  Â  TaskWorkerGenerator generator = generators.get(taskType);

Â  Â  Â  Â  if (generator == null) {

Â  Â  Â  Â  Â  Â  throw new UnsupportedTaskTypeException(

Â  Â  Â  Â  Â  Â  Â  Â  "ä¸æ”¯æŒçš„ä»»åŠ¡ç±»å‹: " + taskType);

Â  Â  Â  Â  }

Â  Â  Â  Â  return generator.getMyTaskWorker(task);

Â  Â  }

}

```

  

## ğŸ¯ æ”¹è¿›è·¯çº¿å›¾

  

### çŸ­æœŸæ”¹è¿› (1-2å‘¨)

| ä¼˜å…ˆçº§ | æ”¹è¿›é¡¹ | é¢„æœŸæ”¶ç›Š | å·¥ä½œé‡ |

|-------|--------|----------|--------|

| ğŸ”´ é«˜ | ä¿®å¤å¹¶å‘å®‰å…¨é—®é¢˜ | æ¶ˆé™¤æ•°æ®ä¸ä¸€è‡´é£é™© | 2äººæ—¥ |

| ğŸ”´ é«˜ | ä¼˜åŒ–çº¿ç¨‹æ± é…ç½® | æå‡20-30%æ€§èƒ½ | 3äººæ—¥ |

| ğŸŸ¡ ä¸­ | å¢åŠ å…³é”®ç›‘æ§æŒ‡æ ‡ | æå‡å¯è§‚æµ‹æ€§ | 5äººæ—¥ |

| ğŸŸ¡ ä¸­ | é…ç½®å‚æ•°åŒ–æ”¹é€  | æå‡å¯ç»´æŠ¤æ€§ | 3äººæ—¥ |

  

**å®æ–½è®¡åˆ’**:

1. **ç¬¬1å‘¨**: å¹¶å‘å®‰å…¨é—®é¢˜ä¿®å¤ + çº¿ç¨‹æ± ä¼˜åŒ–

2. **ç¬¬2å‘¨**: ç›‘æ§æŒ‡æ ‡æ·»åŠ  + é…ç½®å‚æ•°åŒ–

  

### ä¸­æœŸæ”¹è¿› (1-2æœˆ)

| æ”¹è¿›é¡¹ | æŠ€æœ¯æ–¹æ¡ˆ | é¢„æœŸæ”¶ç›Š |

|--------|----------|----------|

| å¼•å…¥æ¶ˆæ¯é˜Ÿåˆ— | RabbitMQ/Kafka | æ¶ˆé™¤è½®è¯¢ï¼Œæå‡å®æ—¶æ€§ |

| ç†”æ–­é™çº§æœºåˆ¶ | Hystrix/Sentinel | æå‡ç³»ç»Ÿå¯ç”¨æ€§ |

| åˆ†å¸ƒå¼è¿½è¸ª | SkyWalking/Zipkin | æ”¹å–„é—®é¢˜æ’æŸ¥æ•ˆç‡ |

| æ€§èƒ½æµ‹è¯•ä¼˜åŒ– | JMeterå‹æµ‹ | ç¡®å®šæœ€ä¼˜å‚æ•°é…ç½® |

  

### é•¿æœŸæ”¹è¿› (3-6æœˆ)

| é˜¶æ®µ | æ”¹è¿›æ–¹å‘ | æŠ€æœ¯é€‰å‹ |

|------|----------|----------|

| **æ¶æ„å‡çº§** | äº‹ä»¶é©±åŠ¨æ¶æ„ | Spring Cloud Stream |

| **äº‘åŸç”ŸåŒ–** | å®¹å™¨åŒ–éƒ¨ç½² | Docker + Kubernetes |

| **å¼¹æ€§æ‰©ç¼©å®¹** | è‡ªåŠ¨ä¼¸ç¼© | HPA + VPA |

| **æ•°æ®å¤„ç†** | æµå¼å¤„ç† | Apache Flink |

  

## ğŸ“Š æ€»ç»“

  

Wallyt-Reconå¯¹è´¦ç³»ç»Ÿé‡‡ç”¨äº†è¾ƒä¸ºæˆç†Ÿçš„å¾®æœåŠ¡æ¶æ„å’Œç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼ï¼Œå…·å¤‡è‰¯å¥½çš„åŸºç¡€æ¶æ„ã€‚ç³»ç»Ÿçš„ä¸»è¦ä¼˜åŠ¿åœ¨äº:

  

1. **æ¸…æ™°çš„æ¨¡å—åˆ’åˆ†**: ä¸‹è½½ã€å¯¹è´¦ã€å…¬å…±ç»„ä»¶åˆ†ç¦»

2. **æˆç†Ÿçš„æŠ€æœ¯æ ˆ**: Spring Boot + Dubbo + MyBatis

3. **å¹¶å‘å¤„ç†èƒ½åŠ›**: å¤šçº¿ç¨‹ + é˜Ÿåˆ—ç®¡ç†

  

ä½†åŒæ—¶ä¹Ÿå­˜åœ¨ä¸€äº›éœ€è¦æ”¹è¿›çš„é—®é¢˜:

  

1. **æ€§èƒ½ç“¶é¢ˆ**: æ•°æ®åº“è½®è¯¢ã€çº¿ç¨‹æ± é…ç½®ä¸å½“

2. **å¯é æ€§é£é™©**: å¹¶å‘å®‰å…¨ã€å¼‚å¸¸å¤„ç†ä¸å®Œå–„

3. **å¯è§‚æµ‹æ€§ä¸è¶³**: ç¼ºä¹ç›‘æ§æŒ‡æ ‡å’Œåˆ†å¸ƒå¼è¿½è¸ª

  

é€šè¿‡æŒ‰ç…§çŸ­æœŸã€ä¸­æœŸã€é•¿æœŸçš„æ”¹è¿›è·¯çº¿å›¾å®æ–½ä¼˜åŒ–ï¼Œå¯ä»¥æ˜¾è‘—æå‡ç³»ç»Ÿçš„æ€§èƒ½ã€å¯é æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚å»ºè®®ä¼˜å…ˆè§£å†³å¹¶å‘å®‰å…¨å’Œæ€§èƒ½ä¼˜åŒ–é—®é¢˜ï¼Œç„¶åé€æ­¥å¼•å…¥ç°ä»£åŒ–çš„æŠ€æœ¯æ ˆå’Œæ¶æ„æ¨¡å¼ã€‚

  

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0 Â 

**ç”Ÿæˆæ—¶é—´**: 2024å¹´ Â 

**åˆ†æèŒƒå›´**: wallyt-recon å®Œæ•´æ¨¡å—æ¶æ„